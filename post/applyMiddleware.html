<!DOCTYPE html><html lang="en-US"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><title>redux源码系列之applyMiddleware | Xu dongdong&#x27;s blog</title><meta name="description" content="A blog created with Next.js and Tailwind.css"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="redux源码系列之applyMiddleware"/><meta name="og:description" property="og:description" content="A blog created with Next.js and Tailwind.css"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="redux源码系列之applyMiddleware"/><meta name="twitter:description" content="A blog created with Next.js and Tailwind.css"/><meta name="twitter:creator" content="https://twitter.com/WhyYouJames"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/f8d73a71d7937abe53e1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f8d73a71d7937abe53e1.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-c6f966696d7d46f48c33.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.10b3d8f36ae5d485c3da.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.18cd929bdef6e2f96561.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c6d80ab417193f95407.js" as="script"/><link rel="preload" href="/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.c3b64f225a2ce340a522.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/post/%5Bslug%5D-48f028bae094661c2f5e.js" as="script"/></head><body><div id="__next"><div class="w-full min-h-screen dark:bg-gray-700 dark:text-white flex"><div class="max-w-screen-md px-4 py-12 mx-auto antialiased font-body flex flex-col flex-grow"><header class="flex items-center justify-between  mb-2"><div class="max-w-lg"><h1><a class="text-2xl font-black text-black no-underline font-display dark:text-white" href="/">Xu dongdong&#x27;s blog</a></h1></div></header><main class="flex-grow"><article><header class="mb-8"><h1 class="mb-2 text-6xl font-black leading-none font-display">redux源码系列之applyMiddleware</h1></header><div class="mb-4 prose lg:prose-lg dark:prose-dark"><p>终于来到 <strong>applyMiddleware</strong> 部分，理解了 <a href="https://xudongdong.site/post/compose"><strong>compose</strong></a> 和 <a href="https://xudongdong.site/post/currying"><strong>Currying</strong></a>，这部分源码也变得很好理解</p><p>这个方法是用来应用中间件的，用过 <strong>node</strong> 的同学应该比较了解，中间件我的理解类似于插件，一般为了避免系统框架过于臃肿，我们把常用的功能剥离开来，以中间件的形式插入到框架中来实现复杂的应用处理</p><p>我们首先看下 <strong>applyMiddleware</strong> 的用法</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports" style="color:#f8f8f2">{</span><span class="token imports"> applyMiddleware </span><span class="token imports" style="color:#f8f8f2">}</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports">thunk</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux-thunk&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports">logger</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux-logger&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f1fa8c">applyMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span>thunk</span><span class="token" style="color:#f8f8f2">,</span><span> logger</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span></code></pre><p><strong>createStore</strong> 内部的调用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">reducer</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> preloadedState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> enhancer</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 传入参数的判断</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// ...</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 参数中enhancer function存在，一般是指applyMiddleware()</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> enhancer </span><span class="token" style="color:#f8f8f2">!==</span><span> </span><span class="token" style="color:#50fa7b">&quot;undefined&quot;</span><span> </span><span class="token" style="color:#f8f8f2">&amp;&amp;</span><span> </span><span class="token" style="color:#8be9fd">typeof</span><span> enhancer </span><span class="token" style="color:#f8f8f2">===</span><span> </span><span class="token" style="color:#50fa7b">&quot;function&quot;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">enhancer</span><span class="token" style="color:#f8f8f2">(</span><span>createStore</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 省略</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>由此可以得出 <strong>applyMiddleware</strong> 的 <strong>API</strong> 调用</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#f1fa8c">applyMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span>thunk</span><span class="token" style="color:#f8f8f2">,</span><span> logger</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>createStore</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#6272a4">// applyMiddleware(...middlewares)(createStore)(reducer, preloadedState);</span></code></pre><p>结合源码</p><p>我们将源码中 <strong>TS</strong> 部分去除，得出函数主体代码</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports" style="color:#f8f8f2">{</span><span class="token imports"> compose </span><span class="token imports" style="color:#f8f8f2">}</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&quot;./compose&quot;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">applyMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter spread" style="color:#f8f8f2">...</span><span class="token parameter">middlewares</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// use Currying function</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">createStore</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">reducer</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// 获取store</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// 初始化dispatch</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">let</span><span> </span><span class="token function-variable" style="color:#f1fa8c">dispatch</span><span> </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// 在dispatch完成正在赋值之前，调用会报错</span><span>
</span><span>      </span><span class="token control-flow" style="color:#8be9fd">throw</span><span> </span><span class="token" style="color:#8be9fd">new</span><span> </span><span class="token" style="color:#f1fa8c">Error</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#50fa7b">&quot;目前还不能使用dispatch&quot;</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>    </span><span class="token" style="color:#6272a4">// 给每个中间件的默认传参：getState，dispatch</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">const</span><span> middlewareAPI </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      getState</span><span class="token" style="color:#f8f8f2">:</span><span> store</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">getState</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>      </span><span class="token function-variable" style="color:#f1fa8c">dispatch</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">action</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> </span><span class="token parameter spread" style="color:#f8f8f2">...</span><span class="token parameter">args</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f1fa8c">dispatch</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token spread" style="color:#f8f8f2">...</span><span>args</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>    
<span>    </span><span class="token" style="color:#6272a4">// 加入默认参数后的中间件chain</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">const</span><span> chain </span><span class="token" style="color:#f8f8f2">=</span><span> middlewares</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">map</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">middleware</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f1fa8c">middleware</span><span class="token" style="color:#f8f8f2">(</span><span>middlewareAPI</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// 对chain做compose操作，并赋值给dispatch</span><span>
</span><span>    dispatch </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">compose</span><span class="token" style="color:#f8f8f2">(</span><span class="token spread" style="color:#f8f8f2">...</span><span>chain</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>store</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">dispatch</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 返回store的属性和dispatch</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token spread" style="color:#f8f8f2">...</span><span>store</span><span class="token" style="color:#f8f8f2">,</span><span>
</span>    dispatch
<span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>主要难以理解的部分还是 <strong>compose</strong> 这一块</p><p>我们拿两个中间件做解析</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports">thunk</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux-thunk&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports">logger</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux-logger&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#f1fa8c">applyMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span>thunk</span><span class="token" style="color:#f8f8f2">,</span><span> logger</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>createStore</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#6272a4">// applyMiddleware chain部分</span><span>
</span><span></span><span class="token" style="color:#8be9fd">const</span><span> middlewareAPI </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> dispatch </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> chain </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">[</span><span>thunk</span><span class="token" style="color:#f8f8f2">,</span><span> logger</span><span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">map</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">middleware</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f1fa8c">middleware</span><span class="token" style="color:#f8f8f2">(</span><span>middlewareAPI</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span></span><span class="token" style="color:#6272a4">// const chain = [thunk(middlewareAPI), logger(middlewareAPI)]</span><span>
</span><span></span><span class="token" style="color:#6272a4">// const chain = [thunk({ getState, dispatch }), logger({ getState, dispatch })]</span><span>
</span>
<span></span><span class="token" style="color:#6272a4">// applyMiddleware compose dispatch部分</span><span>
</span><span>dispatch </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">compose</span><span class="token" style="color:#f8f8f2">(</span><span class="token spread" style="color:#f8f8f2">...</span><span>chain</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>store</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">dispatch</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span></span><span class="token" style="color:#6272a4">// dispatch = compose(thunk({ getState, dispatch }), logger({ getState, dispatch }))(store.dispatch)</span><span>
</span>
<span></span><span class="token" style="color:#6272a4">// 根据 compose 代码可转化为</span><span>
</span><span></span><span class="token" style="color:#6272a4">// dispatch = thunk({ getState, dispatch })(logger({ getState, dispatch })(store.dispatch))</span></code></pre><p>代码到这边我们需要结合 <strong>redux-thunk</strong> 源码继续解析了</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">createThunkMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">extraArgument</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter"> dispatch</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> getState </span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">next</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token control-flow" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> action </span><span class="token" style="color:#f8f8f2">===</span><span> </span><span class="token" style="color:#50fa7b">&#x27;function&#x27;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">action</span><span class="token" style="color:#f8f8f2">(</span><span>dispatch</span><span class="token" style="color:#f8f8f2">,</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> extraArgument</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>    </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">next</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> thunk </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createThunkMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>thunk</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">withExtraArgument</span><span> </span><span class="token" style="color:#f8f8f2">=</span><span> createThunkMiddleware</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token module" style="color:#8be9fd">export</span><span> </span><span class="token module" style="color:#8be9fd">default</span><span> thunk</span><span class="token" style="color:#f8f8f2">;</span></code></pre><p>把</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>dispatch </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">thunk</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> dispatch </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f1fa8c">logger</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> dispatch </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>store</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">dispatch</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span></code></pre><p>放到 <strong>thunk</strong> 中</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token function-variable" style="color:#f1fa8c">dispatch</span><span> </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter"> getState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> dispatch </span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter"> getState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> dispatch </span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f1fa8c">logger</span><span class="token parameter" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter"> getState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> dispatch </span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token parameter" style="color:#f8f8f2">)</span><span class="token parameter" style="color:#f8f8f2">(</span><span class="token parameter">store</span><span class="token parameter" style="color:#f8f8f2">.</span><span class="token parameter property-access">dispatch</span><span class="token parameter" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span>
<span>    </span><span class="token" style="color:#6272a4">// 如果有异步action，会先执行异步action，在执行传进来的logger function</span><span>
</span><span>    </span><span class="token control-flow" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> action </span><span class="token" style="color:#f8f8f2">===</span><span> </span><span class="token" style="color:#50fa7b">&#x27;function&#x27;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">action</span><span class="token" style="color:#f8f8f2">(</span><span>dispatch</span><span class="token" style="color:#f8f8f2">,</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> extraArgument</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>    </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">logger</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> getState</span><span class="token" style="color:#f8f8f2">,</span><span> dispatch </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>store</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">dispatch</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>应用了 <strong>thunk</strong> 和 <strong>logger</strong> 的 <strong>redux</strong> 应用，会先执行异步 <strong>action</strong>，在执行 <strong>logger</strong> 中间件。</p><p>从代码上看，<strong>applyMiddleware</strong> 最主要的作用就是对原始的 <strong>dispatch</strong> 方法进行了重新赋值，并将它与 <strong>store</strong> 的属性返回。</p><h2>参考</h2><ul><li><a href="https://github.com/reduxjs/redux-thunk/blob/master/src/index.js">redux-thunk</a></li></ul></div><hr class="mt-4"/><footer><div class="flex items-center mt-8 mb-16"><picture class="flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14 select-none cursor-pointer hvr-float-shadow"><source type="image/webp" data-srcset="/_next/static/images/profile-8ed88833980dc158e6d9ec3b1bb7c0a8.png.webp"/><source type="image/png" data-srcset="/_next/static/images/profile-44443f720aaa2ff4c2b67336ff9f586b.png"/><img class="lazyload blur flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14 select-none cursor-pointer hvr-float-shadow" alt="Profile" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAAAklEQVR4AewaftIAAAFBSURBVAXBSS8DYQCA4fcz33RqWpUuU8tEkKjtUqIhJELiRCJxcfRf/AknP8OFiwMXF40DSVO0iRhLVbR0mX08jzg63Ikc28NzA1QR8vBcJ6Eq9AYUDMNAxlOsrBSRH40WIoLJbIL1qTzS63JvfRKJECd0MM0h9IREmZ4YOyaAw7UCG6UlNpfneaw8UbNa4Ie4tk9uSEO6nouCoO9FZEZNWu8WcUViZpLsH+wyMjnBX7eDzCuQ0zVsAtpvb1RrL9Stb3RNkO//MSwl6mAcWRrNMLO1jZ5UuSiXITXO6vISp+eXbNs+olal02kj/YUidiyJ5wsK63u8N74xSxmmyrecnF2TNtJoUkUa2RxO95ew3+al1yXm9tCCiLnCLPqrRbP5QSRC5GLsi0DVkekUj5UKjZ8+TSdA6ikWigYDqs/VzR3/TEV/Airrby8AAAAASUVORK5CYII="/></picture><p class="text-base leading-7 font-semibold">不正经的人机交互工程师</p></div></footer></article><nav class="flex flex-wrap justify-between mb-10"><a class="text-lg font-bold" href="/post/currying">← <!-- -->柯里化-Currying</a><a class="text-lg font-bold" href="/post/method">js常用方法集合（一）<!-- --> →</a></nav></main><footer class="text-lg font-light mt-3">© <!-- -->2021<!-- --> <!-- -->Built with<!-- --> <a href="https://nextjs.org/">Next.js</a>🔥, Deployed on<!-- --> <a href="https://pages.github.com/">GitHub Pages</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"redux源码系列之applyMiddleware","date":"June 28, 2021","description":null},"post":{"content":"\n终于来到 **applyMiddleware** 部分，理解了 [**compose**](https://xudongdong.site/post/compose) 和 [**Currying**](https://xudongdong.site/post/currying)，这部分源码也变得很好理解\n\n这个方法是用来应用中间件的，用过 **node** 的同学应该比较了解，中间件我的理解类似于插件，一般为了避免系统框架过于臃肿，我们把常用的功能剥离开来，以中间件的形式插入到框架中来实现复杂的应用处理\n\n我们首先看下 **applyMiddleware** 的用法\n\n``` js\nimport { applyMiddleware } from 'redux';\nimport thunk from 'redux-thunk';\nimport logger from 'redux-logger';\n\nconst store = createStore(reducer, applyMiddleware(thunk, logger))\n```\n\n**createStore** 内部的调用\n\n``` js\nfunction createStore(reducer, preloadedState, enhancer) {\n  // 传入参数的判断\n  // ...\n\n  // 参数中enhancer function存在，一般是指applyMiddleware()\n  if (typeof enhancer !== \"undefined\" \u0026\u0026 typeof enhancer === \"function\") {\n    return enhancer(createStore)(reducer, preloadedState);\n  }\n\n  // 省略\n}\n```\n\n由此可以得出 **applyMiddleware** 的 **API** 调用\n\n``` js\napplyMiddleware(thunk, logger)(createStore)(reducer, preloadedState);\n\n// applyMiddleware(...middlewares)(createStore)(reducer, preloadedState);\n```\n\n结合源码\n\n我们将源码中 **TS** 部分去除，得出函数主体代码\n\n``` javascript\nimport { compose } from \"./compose\";\n\nfunction applyMiddleware(...middlewares) {\n  // use Currying function\n  return (createStore) =\u003e (reducer, preloadedState) =\u003e {\n    // 获取store\n    const store = createStore(reducer, preloadedState);\n    // 初始化dispatch\n    let dispatch = () =\u003e {\n      // 在dispatch完成正在赋值之前，调用会报错\n      throw new Error(\"目前还不能使用dispatch\")\n    }\n\n    // 给每个中间件的默认传参：getState，dispatch\n    const middlewareAPI = {\n      getState: store.getState,\n      dispatch: (action, ...args) =\u003e dispatch(action, ...args)\n    }\n    \n    // 加入默认参数后的中间件chain\n    const chain = middlewares.map(middleware =\u003e middleware(middlewareAPI))\n    // 对chain做compose操作，并赋值给dispatch\n    dispatch = compose(...chain)(store.dispatch)\n  }\n\n  // 返回store的属性和dispatch\n  return {\n    ...store,\n    dispatch\n  }\n}\n```\n\n主要难以理解的部分还是 **compose** 这一块\n\n我们拿两个中间件做解析\n\n``` javascript\nimport thunk from 'redux-thunk';\nimport logger from 'redux-logger';\n\napplyMiddleware(thunk, logger)(createStore)(reducer, preloadedState);\n\n// applyMiddleware chain部分\nconst middlewareAPI = { getState, dispatch }\n\nconst chain = [thunk, logger].map(middleware =\u003e middleware(middlewareAPI))\n// const chain = [thunk(middlewareAPI), logger(middlewareAPI)]\n// const chain = [thunk({ getState, dispatch }), logger({ getState, dispatch })]\n\n// applyMiddleware compose dispatch部分\ndispatch = compose(...chain)(store.dispatch)\n// dispatch = compose(thunk({ getState, dispatch }), logger({ getState, dispatch }))(store.dispatch)\n\n// 根据 compose 代码可转化为\n// dispatch = thunk({ getState, dispatch })(logger({ getState, dispatch })(store.dispatch))\n```\n\n代码到这边我们需要结合 **redux-thunk** 源码继续解析了\n\n``` js\nfunction createThunkMiddleware(extraArgument) {\n  return ({ dispatch, getState }) =\u003e (next) =\u003e (action) =\u003e {\n    if (typeof action === 'function') {\n      return action(dispatch, getState, extraArgument);\n    }\n\n    return next(action);\n  };\n}\n\nconst thunk = createThunkMiddleware();\nthunk.withExtraArgument = createThunkMiddleware;\n\nexport default thunk;\n```\n\n把\n``` js\ndispatch = thunk({ getState, dispatch })(logger({ getState, dispatch })(store.dispatch))\n```\n\n放到 **thunk** 中\n\n``` js\ndispatch = ({ getState, dispatch }) =\u003e {\n  return ({ getState, dispatch }) =\u003e (logger({ getState, dispatch })(store.dispatch)) =\u003e (action) =\u003e {\n\n    // 如果有异步action，会先执行异步action，在执行传进来的logger function\n    if (typeof action === 'function') {\n      return action(dispatch, getState, extraArgument);\n    }\n\n    return logger({ getState, dispatch })(store.dispatch)(action);\n  }\n}\n```\n\n应用了 **thunk** 和 **logger** 的 **redux** 应用，会先执行异步 **action**，在执行 **logger** 中间件。\n\n从代码上看，**applyMiddleware** 最主要的作用就是对原始的 **dispatch** 方法进行了重新赋值，并将它与 **store** 的属性返回。\n\n\n## 参考\n- [redux-thunk](https://github.com/reduxjs/redux-thunk/blob/master/src/index.js)\n\n","excerpt":""},"previousPost":{"slug":"currying","frontmatter":{"title":"柯里化-Currying","date":"June 23, 2021","description":null},"excerpt":"","content":"\n之前看 **Redux compose** 部分源代码的时候，就感觉和 **柯里化（Currying）** 很像，所以这篇把它安排上了，同属于函数式编程范畴。\n\n## What\n\n什么是柯里化（Currying）\n\n**柯里化** 大家应该听说过，或许还有些了解，但是到底什么样的范式才是柯里化呢？\n\n\u003e在维基百科上的定义是这样：***currying is the technique of converting a function that takes multiple arguments into a sequence of functions that each takes a single argument***.\n\n首先是一个技术，作用是将一个拥有多个参数的函数转化成一系列只能传入一个参数的函数。\n\n还是比较抽象，通过代码\n\n``` js\nconst add = (x) =\u003e (y) =\u003e x + y;\n```\n\n这种多 **=\u003e** 的代码经常见，其实就是 **ES6** 版的柯里化，我们可以转化下\n\n觉得理解困难的可以借用 **[Babel](https://www.babeljs.cn/repl)** 来转化\n\n``` js\nvar add = function add(x) {\n  return function (y) {\n    return x + y;\n  };\n};\n```\n\n不用 **柯里化（Currying）**:\n\n``` js\nconst add = (a, b, c) =\u003e {\n  return a + b + c;\n}\n```\n\n在数学和计算机科学中的柯里化函数，一次只能传递一个参数；\n\n而我们 **Javascript** 实际应用中的柯里化函数，可以传递一个或多个参数。\n\n``` js\n//普通函数\nfunction fn(a, b, c, d, e) {\n  return a + b + c + d + e;\n}\n//生成的柯里化函数\nconst curryFn = curry(fn);\n\ncurryFn(1,2,3,4,5);     // 15\ncurryFn(1)(2)(3,4,5);   // 15\ncurryFn(1,2)(3,4)(5);   // 15\ncurryFn(1)(2)(3)(4)(5); // 15\n\n```\n\n那么什么时候应该用 **柯里化（Currying）** 呢，总不至于我们就是用来为了给三个数字求和。\n\n## When\n\n举个例子🌰\n\n科颜氏有一款爆火的爽肤水，经常会有活动促销打折，打折力度往往不一样\n\n所以他们会这样计算折后价格\n\n``` js\nconst discountPrice = (price, dicount) =\u003e {\n  return price * dicount;\n}\n\ndiscountPrice(300, 0.9);\ndiscountPrice(300, 0.95);\ndiscountPrice(300, 0.85);\ndiscountPrice(300, 0.88);\n```\n\n其实我们会发现，虽然折扣经常变，但是它本身的价格基本不变\n\n所以我们可以用 **柯里化（Currying）** 优化下代码结构\n\n``` js\nconst defaultPrice = 300; // 爽肤水默认价格\n\nconst discountPrice = (price) =\u003e {\n  return (dicount) =\u003e {\n    return price * dicount;\n  }\n}\n\n// const discountPrice = price =\u003e dicount =\u003e price * dicount\n\nconst tonerdDscountPrice = discountPrice(defaultPrice);\n\ntonerdDscountPrice(0.9);\ntonerdDscountPrice(0.95);\ntonerdDscountPrice(0.85);\ntonerdDscountPrice(0.88);\n```\n\n下面的代码是不是调用的时候更加舒爽一点\n\n## Why\n\n那么 **柯里化（Currying）** 有啥好处呢\n\n柯里化本质上是 ***降低通用性，提高适用性***。\n\n怎么理解...\n\n结合打折的例子看，\n\n降低通用性是指 **Currying** 之前，我们可以灵活的传入默认价格，我可以算出爽肤水折扣价格，也可以算出面膜折扣价格，很通用\n\n但是 **Currying** 之后更加适用于算出爽肤水折扣价格了，都不用传入默认价格了，提取了一个通用的方法对默认价格进行处理，只要传入折扣价格\n\n所以，关于使用其实是个取舍问题，需结合具体场景\n\n\n\n\n\n\n\n## 参考\n- [currying-javascript](https://www.dottedsquirrel.com/currying-javascript/)\n- [wiki-Currying](https://en.wikipedia.org/wiki/Currying)\n- [javascript-currying-what-is-the-point-of-currying-javascript-functions](https://www.jondjones.com/frontend/javascript/functional-programming/javascript-currying-what-is-the-point-of-currying-javascript-functions/)\n- [「前端进阶」彻底弄懂函数柯里化](https://juejin.cn/post/6844903882208837645)"},"nextPost":{"slug":"method","frontmatter":{"title":"js常用方法集合（一）","date":"June 30, 2021","description":null},"excerpt":"","content":"\n## Array\n\n1. 将输入值转化为数组\n\n``` javascript\nconst castArray = value =\u003e Array.isArray(value) ? value : [value];\n\n// Examples\ncastArray(1);               // [1]\ncastArray([1, 2, 3]);       // [1, 2, 3]\n```\n\n2. 判断数组是否为空\n\n``` javascript\nconst isEmpty = arr =\u003e Array.isArray(arr) \u0026\u0026 arr.length === 0;\n\n// Examples\nisEmpty(1);             // false\nisEmpty([]);            // true\nisEmpty([1, 2, 3]);     // false\n```\n\n3. 拷贝一个数组\n\n``` javascript\n// `arr` is an array\nconst clone = arr =\u003e arr.slice(0);\n\n// Or\nconst clone = arr =\u003e arr.concat([]);\n\n// Or\nconst clone = arr =\u003e [...arr];\n\n// Or\nconst clone = arr =\u003e Array.from(arr);\n\n// Or\nconst clone = arr =\u003e arr.map(v =\u003e v);\n```\n\n4. 对比两个数组是否一样\n   \n``` javascript\nconst isEqual = (arr1, arr2) =\u003e arr1.length === arr2.length \u0026\u0026 arr1.every((v, i) =\u003e v === arr2[i]);\n\n// Examples\nisEqual([1, 2, 3], [1, 2, 3]);      // true\nisEqual([1, 2, 3], [1, '2', 3]);    // false\n```\n\n5. 根据某个属性将数组转化为对象（属性作为key）\n\n``` javascript\nconst toObject = (arr, key) =\u003e arr.reduce((a, b) =\u003e ({...a, [b[key]]: b}), {});\n\n// Example\ntoObject(\n    [\n        { id: '1', name: 'Alpha', gender: 'Male' },\n        { id: '2', name: 'Bravo', gender: 'Male' },\n        { id: '3', name: 'Charlie', gender: 'Female' },\n    ],\n    'id'\n);\n/* \n{\n    '1': { id: '1', name: 'Alpha', gender: 'Male' },\n    '2': { id: '2', name: 'Bravo', gender: 'Male' },\n    '3': { id: '3', name: 'Charlie', gender: 'Female' },\n}\n*/\n```\n\n6. 找出数组中最大的值（Number）\n\n``` javascript\nconst indexOfMax = arr =\u003e arr.reduce((prev, v, i, a) =\u003e v \u003e a[prev] ? i : prev, 0);\n\n// Examples\nindexOfMax([1, 3, 9, 7, 5]);        // 2\nindexOfMax([1, 3, 7, 7, 5]);        // 2\n```\n\n7. 根据属性找出数组中属性值最大的\n\n``` javascript\nconst maxBy = (arr, key) =\u003e arr.reduce((a, b) =\u003e a[key] \u003e= b[key] ? a : b, {});\n\n// Example\nconst people = [\n    { name: 'Bar', age: 24 },\n    { name: 'Baz', age: 32 },\n    { name: 'Foo', age: 42 },\n    { name: 'Fuzz', age: 36 },\n];\nmaxBy(people, 'age');   // { name: 'Foo', age: 42 }\n```\n\n8. 数组去重\n\n``` javascript\nconst unique = arr =\u003e Array.from(new Set(arr));\n\n// Or\nconst unique = arr =\u003e arr.filter((el, i, array) =\u003e array.indexOf(el) === i);\n```\n\n9. 以属性值为key将数组转化成对象\n\n``` javascript\nconst groupBy = (arr, key) =\u003e arr.reduce((acc, item) =\u003e ((acc[item[key]] = [...(acc[item[key]] || []), item]), acc), {});\n\n// Example\ngroupBy([\n    { branch: 'audi', model: 'q8', year: '2019' },\n    { branch: 'audi', model: 'rs7', year: '2020' },\n    { branch: 'ford', model: 'mustang', year: '2019' },\n    { branch: 'ford', model: 'explorer', year: '2020' },\n    { branch: 'bmw', model: 'x7', year: '2020' },\n], 'branch');\n\n/*\n{\n    audi: [\n        { branch: 'audi', model: 'q8', year: '2019' },\n        { branch: 'audi', model: 'rs7', year: '2020' }\n    ],\n    bmw: [\n        { branch: 'bmw', model: 'x7', year: '2020' }\n    ],\n    ford: [\n        { branch: 'ford', model: 'mustang', year: '2019' },\n        { branch: 'ford', model: 'explorer', year: '2020' }\n    ],\n}\n*/\n```\n\n10. 根据属性值给数组排序\n\n``` javascript\nconst sortBy = (arr, k) =\u003e arr.concat().sort((a, b) =\u003e (a[k] \u003e b[k]) ? 1 : ((a[k] \u003c b[k]) ? -1 : 0));\n\n// Example\nconst people = [\n    { name: 'Foo', age: 42 },\n    { name: 'Bar', age: 24 },\n    { name: 'Fuzz', age: 36 },\n    { name: 'Baz', age: 32 },\n];\nsortBy(people, 'age');\n\n// returns\n//  [\n//      { name: 'Bar', age: 24 },\n//      { name: 'Baz', age: 32 },\n//      { name: 'Fuzz', age: 36 },\n//      { name: 'Foo', age: 42 },\n//  ]\n```\n\n## DOM\n\n1. 判断是否为某个元素的子节点\n\n``` javascript\nconst isDescendant = (child, parent) =\u003e parent.contains(child);\n```\n\n2. 判断当前元素是否是Focus状态\n\n``` javascript\nconst isFocus = ele =\u003e ele === document.activeElement;\n```\n\n3. 判断页面是否滑到底部\n\n``` javascript\nconst isAtBottom = () =\u003e document.documentElement.clientHeight + window.scrollY \u003e= document.documentElement.scrollHeight;\n```\n\n4. 当前浏览器判断\n\n``` javascript\n\n// IE\nconst isIE = !!document.documentMode;\n\n// Chrome\nconst isChrome = !!window.chrome \u0026\u0026 (!!window.chrome.webstore || !!window.chrome.runtime);\n\n// macOS browser\nconst isMacBrowser = /Mac|iPod|iPhone|iPad/.test(navigator.platform);\n```\n\n5. 获取用户选中的文本\n\n``` javascript\nconst getSelectedText = () =\u003e window.getSelection().toString();\n```\n\n6. 隐藏元素\n  \n``` javascript\nconst hide = ele =\u003e ele.style.display = 'none';\n\n// Or\nconst hide = ele =\u003e ele.style.visibility = 'hidden';\n\n// Or\nconst hide = ele =\u003e ele.hidden = true;\n```\n\n7. 将元素插入某个元素之后\n\n``` javascript\nconst insertAfter = (ele, anotherEle) =\u003e anotherEle.parentNode.insertBefore(ele, anotherEle.nextSibling);\n\n// Or\nconst insertAfter = (ele, anotherEle) =\u003e anotherEle.insertAdjacentElement('afterend', ele);\n```\n\n8. 跳转页面\n\n``` javascript\nconst goTo = url =\u003e location.href = url;\n```\n\n9. 重新加载当前页\n\n``` javascript\nconst reload = () =\u003e location.reload();\n\n// Or\nconst reload = () =\u003e (location.href = location.href);\n```\n\n10. 替换元素\n\n``` javascript\nconst replace = (ele, newEle) =\u003e ele.parentNode.replaceChild(newEle, ele);\n```\n\n11. 回到页面顶部\n\n``` javascript\nconst goToTop = () =\u003e window.scrollTo(0, 0);\n```"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"applyMiddleware"},"buildId":"XwhSp0ByxPtlsol1y3pMQ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-c6f966696d7d46f48c33.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.10b3d8f36ae5d485c3da.js" async=""></script><script src="/_next/static/chunks/commons.18cd929bdef6e2f96561.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c6d80ab417193f95407.js" async=""></script><script src="/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.c3b64f225a2ce340a522.js" async=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-48f028bae094661c2f5e.js" async=""></script><script src="/_next/static/XwhSp0ByxPtlsol1y3pMQ/_buildManifest.js" async=""></script><script src="/_next/static/XwhSp0ByxPtlsol1y3pMQ/_ssgManifest.js" async=""></script></body></html>