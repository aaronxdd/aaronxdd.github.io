<!DOCTYPE html><html lang="en-US"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><title>redux源码系列之createStore | Xu dongdong&#x27;s blog</title><meta name="description" content="深入源码解析createStore内部代码"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="redux源码系列之createStore"/><meta name="og:description" property="og:description" content="深入源码解析createStore内部代码"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="redux源码系列之createStore"/><meta name="twitter:description" content="深入源码解析createStore内部代码"/><meta name="twitter:creator" content="https://twitter.com/WhyYouJames"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/f8d73a71d7937abe53e1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f8d73a71d7937abe53e1.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-c6f966696d7d46f48c33.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.10b3d8f36ae5d485c3da.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.18cd929bdef6e2f96561.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c6d80ab417193f95407.js" as="script"/><link rel="preload" href="/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.c3b64f225a2ce340a522.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/post/%5Bslug%5D-e6569f7c0ca247bf517f.js" as="script"/></head><body><div id="__next"><div class="w-full min-h-screen dark:bg-gray-700 dark:text-white flex"><div class="max-w-screen-md px-4 py-12 mx-auto antialiased font-body flex flex-col flex-grow"><header class="flex items-center justify-between  mb-2"><div class="max-w-lg"><h1><a class="text-2xl font-black text-black no-underline font-display dark:text-white" href="/">Xu dongdong&#x27;s blog</a></h1></div></header><main class="flex-grow"><article><header class="mb-8"><h1 class="mb-2 text-6xl font-black leading-none font-display">redux源码系列之createStore</h1></header><div class="mb-4 prose lg:prose-lg dark:prose-dark"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f8f8f2">[</span><span>initState</span><span class="token" style="color:#f8f8f2">,</span><span> enhancer</span><span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">)</span></code></pre><h2>参数</h2><ol><li><p><a href="https://redux.js.org/understanding/thinking-in-redux/glossary#reducer"><strong>reducer</strong></a> (<em>Function</em>):  接受两个参数，分别是当前的 <strong>state</strong> 和要处理的 <a href="https://redux.js.org/tutorials/fundamentals/part-2-concepts-data-flow#actions"><strong>action</strong></a></p></li><li><p>[<strong>preloadedState</strong>] (<em>any</em>):  初始状态的 <strong>state</strong>，其实在实际开发中很少在这边给应用赋上初始 <strong>state</strong>，一般会在各自的 <strong>reducer</strong> 中赋上初始 <strong>state</strong>:</p></li></ol><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">const</span><span> initialState </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// reducer</span><span>
</span><span></span><span class="token" style="color:#8be9fd">const</span><span> </span><span class="token function-variable" style="color:#f1fa8c">todoApp</span><span> </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">state </span><span class="token parameter" style="color:#f8f8f2">=</span><span class="token parameter"> initialState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 这里暂不处理任何 action，</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 仅返回传入的 state。</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> state
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>值得注意的是: 通常情况下，通过 <strong>preloadedState</strong> 指定的 <strong>state</strong> 要优先于通过 <strong>reducer</strong> 指定 <strong>state</strong> :</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports" style="color:#f8f8f2">{</span><span class="token imports"> createStore </span><span class="token imports" style="color:#f8f8f2">}</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#6272a4">// reducer</span><span>
</span><span></span><span class="token" style="color:#8be9fd">const</span><span> a </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>state </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#50fa7b">&#x27;lol&#x27;</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> state</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> b </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>state </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#50fa7b">&#x27;wat&#x27;</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> state</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#6272a4">// const combined = combineReducers({ a, b })</span><span>
</span><span></span><span class="token" style="color:#8be9fd">const</span><span> </span><span class="token function-variable" style="color:#f1fa8c">combined</span><span> </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">state </span><span class="token parameter" style="color:#f8f8f2">=</span><span class="token parameter"> </span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> action</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    a</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#f1fa8c">a</span><span class="token" style="color:#f8f8f2">(</span><span>state</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">a</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>    b</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#f1fa8c">b</span><span class="token" style="color:#f8f8f2">(</span><span>state</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">b</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span>combined</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span> a</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#50fa7b">&#x27;horse&#x27;</span><span> </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token console" style="color:#f1fa8c">console</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">log</span><span class="token" style="color:#f8f8f2">(</span><span>store</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">getState</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// { a: &#x27;horse&#x27;, b: &#x27;wat&#x27; }</span></code></pre><ol start="3"><li>[<strong>enhancer</strong>] (<em>Function</em>):  高阶函数，通常是指中间件，必须用 <strong>applyMiddleware()</strong> 包装下：</li></ol><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports" style="color:#f8f8f2">{</span><span class="token imports"> createStore</span><span class="token imports" style="color:#f8f8f2">,</span><span class="token imports"> applyMiddleware </span><span class="token imports" style="color:#f8f8f2">}</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token module" style="color:#8be9fd">import</span><span> </span><span class="token imports">thunk</span><span> </span><span class="token module" style="color:#8be9fd">from</span><span> </span><span class="token" style="color:#50fa7b">&#x27;redux-thunk&#x27;</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">logger</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter" style="color:#f8f8f2">{</span><span class="token parameter"> getState </span><span class="token parameter" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token parameter">next</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token parameter">action</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token console" style="color:#f1fa8c">console</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">log</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#50fa7b">&#x27;will dispatch&#x27;</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span>
</span>
<span>    </span><span class="token" style="color:#6272a4">// Call the next dispatch method in the middleware chain.</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">const</span><span> returnValue </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">next</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">)</span><span>
</span>
<span>    </span><span class="token console" style="color:#f1fa8c">console</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">log</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#50fa7b">&#x27;state after dispatch&#x27;</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f1fa8c">getState</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span>
</span>
<span>    </span><span class="token" style="color:#6272a4">// This will likely be the action itself, unless</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// a middleware further in chain changed it.</span><span>
</span><span>    </span><span class="token control-flow" style="color:#8be9fd">return</span><span> returnValue
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span></span><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span>todos</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f1fa8c">applyMiddleware</span><span class="token" style="color:#f8f8f2">(</span><span>thunk</span><span class="token" style="color:#f8f8f2">,</span><span> logger</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span></code></pre><h2>返回值</h2><p><a href="https://redux.js.org/api/store"><strong>store</strong></a>: 是一个对象，包含了一些方法（<a href="https://redux.js.org/api/store#dispatchaction"><strong>dispatch</strong></a>，<a href="https://redux.js.org/api/store#getstate"><strong>getState</strong></a>等)，保存了应用所有 <strong>state</strong> 的对象。改变 <strong>state</strong> 的惟一方法是 <strong>dispatch action</strong>。</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">const</span><span> store </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  dispatch</span><span class="token" style="color:#f8f8f2">:</span><span> dispatch </span><span class="token" style="color:#8be9fd">as</span><span> </span><span class="token maybe-class-name">Dispatch</span><span class="token" style="color:#f8f8f2">&lt;</span><span class="token" style="color:#ff79c6">A</span><span class="token" style="color:#f8f8f2">&gt;</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>  subscribe</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>  getState</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>  replaceReducer</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">[</span><span>$$observable</span><span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">:</span><span> observable
</span><span></span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token" style="color:#8be9fd">as</span><span> </span><span class="token" style="color:#50fa7b">unknown</span><span> </span><span class="token" style="color:#8be9fd">as</span><span> </span><span class="token maybe-class-name">Store</span><span class="token" style="color:#f8f8f2">&lt;</span><span class="token maybe-class-name">ExtendState</span><span class="token" style="color:#f8f8f2">&lt;</span><span class="token" style="color:#ff79c6">S</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token maybe-class-name">StateExt</span><span class="token" style="color:#f8f8f2">&gt;</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#ff79c6">A</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token maybe-class-name">StateExt</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token maybe-class-name">Ext</span><span class="token" style="color:#f8f8f2">&gt;</span><span> </span><span class="token" style="color:#f8f8f2">&amp;</span><span> </span><span class="token maybe-class-name">Ext</span><span>
</span><span></span><span class="token" style="color:#8be9fd">return</span><span> store</span></code></pre><h2>代码结构</h2><p>便于理解，我们忽略函数中 <strong>TS</strong> 的一些类型定义，大致结构如下：</p><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-javascript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">createStore</span><span class="token" style="color:#f8f8f2">(</span><span class="token parameter">reducer</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> preloadedState</span><span class="token parameter" style="color:#f8f8f2">,</span><span class="token parameter"> enhancer</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 传入参数的判断</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// ...</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 参数中enhancer function存在，一般是指applyMiddleware()</span><span>
</span><span>  </span><span class="token control-flow" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> enhancer </span><span class="token" style="color:#f8f8f2">!==</span><span> </span><span class="token" style="color:#50fa7b">&quot;undefined&quot;</span><span> </span><span class="token" style="color:#f8f8f2">&amp;&amp;</span><span> </span><span class="token" style="color:#8be9fd">typeof</span><span> enhancer </span><span class="token" style="color:#f8f8f2">===</span><span> </span><span class="token" style="color:#50fa7b">&quot;function&quot;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f1fa8c">enhancer</span><span class="token" style="color:#f8f8f2">(</span><span>createStore</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">(</span><span>reducer</span><span class="token" style="color:#f8f8f2">,</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">let</span><span> currentReducer </span><span class="token" style="color:#f8f8f2">=</span><span> reducer</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// 当前store中的reducer</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">let</span><span> currentState </span><span class="token" style="color:#f8f8f2">=</span><span> preloadedState</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// 当前store中存储的状态</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">let</span><span> currentListeners </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">[</span><span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// 当前store中放置的监听函数</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">let</span><span> nextListeners </span><span class="token" style="color:#f8f8f2">=</span><span> currentListeners</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// 下一次dispatch时的监听函数</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">let</span><span> isDispatching </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">false</span><span class="token" style="color:#f8f8f2">;</span><span> </span><span class="token" style="color:#6272a4">// 用于判断是否正在dispatch</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 获取state</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">getState</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//...</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 添加一个监听函数，每当dispatch被调用的时候都会执行这个监听函数</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">subscribe</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//...</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 触发了一个action，因此我们调用reducer，得到的新的state，并且执行所有添加到store中的监听函数。</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">dispatch</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//...</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 忽略两个不常用的方法replaceReducer，observable...</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// createStore的时候会执行一次INIT action的dispatch</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 便于其他reducer获取初始值</span><span>
</span><span>  </span><span class="token" style="color:#f1fa8c">dispatch</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> type</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token maybe-class-name">ActionTypes</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#ff79c6">INIT</span><span> </span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token module" style="color:#8be9fd">as</span><span> </span><span class="token" style="color:#ff79c6">A</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    dispatch</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>    subscribe</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>    getState</span><span class="token" style="color:#f8f8f2">,</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//下面两个是主要面向库开发者的方法，暂时先忽略</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//replaceReducer,</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//observable</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">;</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>可以看出，<strong>createStore</strong> 方法创建了一个 <strong>store</strong>，但是并没有直接将这个 <strong>store</strong> 的状态 <strong>state</strong> 返回，而是返回了一系列方法，外部可以通过这些方法（<strong>getState</strong>）获取 <strong>state</strong>，或者间接地（通过调用 <strong>dispatch</strong> ）改变 <strong>state</strong>。</p><p>下面我们来看下各个方法的具体实现</p><h3>getState</h3><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">getState</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#ff79c6">S</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 如果正在dispath会抛出异常</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>isDispatching</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">throw</span><span> </span><span class="token" style="color:#8be9fd">new</span><span> </span><span class="token known-class-name" style="color:#f1fa8c">Error</span><span class="token" style="color:#f8f8f2">(</span><span>
</span><span>      </span><span class="token" style="color:#50fa7b">&#x27;You may not call store.getState() while the reducer is executing. &#x27;</span><span> </span><span class="token" style="color:#f8f8f2">+</span><span>
</span><span>        </span><span class="token" style="color:#50fa7b">&#x27;The reducer has already received the state as an argument. &#x27;</span><span> </span><span class="token" style="color:#f8f8f2">+</span><span>
</span><span>        </span><span class="token" style="color:#50fa7b">&#x27;Pass it down from the top reducer instead of reading it from the store.&#x27;</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">return</span><span> currentState </span><span class="token" style="color:#8be9fd">as</span><span> </span><span class="token" style="color:#ff79c6">S</span><span>
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p>很简单，就是获取当前 <strong>state</strong>，我们可以通过 <code>store.getState() = ...</code> 来修改 <strong>state</strong>，但是一般来说，redux不建议这样做，只能通过 <strong>dispatch action</strong> 来修改 <strong>state</strong>。</p><h3>subscribe</h3><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#6272a4">// 若相等，做一下currentListeners浅拷贝</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">ensureCanMutateNextListeners</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>nextListeners </span><span class="token" style="color:#f8f8f2">===</span><span> currentListeners</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      nextListeners </span><span class="token" style="color:#f8f8f2">=</span><span> currentListeners</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">slice</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">subscribe</span><span class="token" style="color:#f8f8f2">(</span><span class="token function-variable" style="color:#f1fa8c">listener</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token arrow" style="color:#f8f8f2">=&gt;</span><span> </span><span class="token" style="color:#8be9fd">void</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> listener </span><span class="token" style="color:#f8f8f2">!==</span><span> </span><span class="token" style="color:#50fa7b">&#x27;function&#x27;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>isDispatching</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">//设置一个标志，标志该监听器已经订阅了</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">let</span><span> isSubscribed </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">true</span><span>
</span>
<span>    </span><span class="token" style="color:#f1fa8c">ensureCanMutateNextListeners</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// push到nextListeners数组中，下次dispatch会调用</span><span>
</span><span>    nextListeners</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">push</span><span class="token" style="color:#f8f8f2">(</span><span>listener</span><span class="token" style="color:#f8f8f2">)</span><span>
</span>
<span>    </span><span class="token" style="color:#6272a4">// 返回了一个取消订阅的函数，即从数组中删除该监听函数</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">return</span><span> </span><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">unsubscribe</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// 如果已经取消订阅过了，直接返回</span><span>
</span><span>      </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">!</span><span>isSubscribed</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>        </span><span class="token" style="color:#8be9fd">return</span><span>
</span><span>      </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span>      </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>isDispatching</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>        </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>      </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>      isSubscribed </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">false</span><span>
</span>
<span>      </span><span class="token" style="color:#f1fa8c">ensureCanMutateNextListeners</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// 从下一轮的监听函数数组（用于下一次dispatch）中删除这个监听器。</span><span>
</span><span>      </span><span class="token" style="color:#8be9fd">const</span><span> index </span><span class="token" style="color:#f8f8f2">=</span><span> nextListeners</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">indexOf</span><span class="token" style="color:#f8f8f2">(</span><span>listener</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>      nextListeners</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#f1fa8c">splice</span><span class="token" style="color:#f8f8f2">(</span><span>index</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#bd93f9">1</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>      </span><span class="token" style="color:#6272a4">// 清空当前currentListeners</span><span>
</span><span>      currentListeners </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#8be9fd">null</span><span>
</span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span></code></pre><h3>dispatch</h3><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">function</span><span> </span><span class="token" style="color:#f1fa8c">dispatch</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">:</span><span> </span><span class="token" style="color:#ff79c6">A</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">!</span><span class="token" style="color:#f1fa8c">isPlainObject</span><span class="token" style="color:#f8f8f2">(</span><span>action</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">typeof</span><span> action</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#8be9fd">type</span><span> </span><span class="token" style="color:#f8f8f2">===</span><span> </span><span class="token" style="color:#50fa7b">&#x27;undefined&#x27;</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">if</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>isDispatching</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// throw Error</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">try</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// 标记正在dispatch</span><span>
</span><span>    isDispatching </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">true</span><span>
</span><span>    </span><span class="token" style="color:#6272a4">// 调用reducer，得到新state</span><span>
</span><span>    currentState </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f1fa8c">currentReducer</span><span class="token" style="color:#f8f8f2">(</span><span>currentState</span><span class="token" style="color:#f8f8f2">,</span><span> action</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token" style="color:#8be9fd">finally</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    isDispatching </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">false</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#8be9fd">const</span><span> listeners </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>currentListeners </span><span class="token" style="color:#f8f8f2">=</span><span> nextListeners</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#6272a4">// 遍历执行监听数组中的所有监听函数</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">for</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#8be9fd">let</span><span> i </span><span class="token" style="color:#f8f8f2">=</span><span> </span><span class="token" style="color:#bd93f9">0</span><span class="token" style="color:#f8f8f2">;</span><span> i </span><span class="token" style="color:#f8f8f2">&lt;</span><span> listeners</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">length</span><span class="token" style="color:#f8f8f2">;</span><span> i</span><span class="token" style="color:#f8f8f2">++</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span><span>    </span><span class="token" style="color:#8be9fd">const</span><span> listener </span><span class="token" style="color:#f8f8f2">=</span><span> listeners</span><span class="token" style="color:#f8f8f2">[</span><span>i</span><span class="token" style="color:#f8f8f2">]</span><span>
</span><span>    </span><span class="token" style="color:#f1fa8c">listener</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span>
</span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#6272a4">// 返回传入的action</span><span>
</span><span>  </span><span class="token" style="color:#8be9fd">return</span><span> action
</span><span></span><span class="token" style="color:#f8f8f2">}</span></code></pre><p><strong>dispatch</strong> 是修改 <strong>state</strong> 的唯一途径（<strong>redux</strong> 规定）。</p><h2>总结</h2><p>整个 <strong>createStore</strong> function 还是比较容易理解的，记住应用中应有且仅有一个 store。</p><h2>参考</h2><ul><li><a href="https://redux.js.org/api/createstore">Redux createStore API</a></li><li><a href="https://www.redux.org.cn/docs/api/createStore.html">Redux createStore API（中文版）</a></li></ul></div><hr class="mt-4"/><footer><div class="flex items-center mt-8 mb-16"><picture class="flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14 select-none cursor-pointer hvr-float-shadow"><source type="image/webp" data-srcset="/_next/static/images/profile-8ed88833980dc158e6d9ec3b1bb7c0a8.png.webp"/><source type="image/png" data-srcset="/_next/static/images/profile-44443f720aaa2ff4c2b67336ff9f586b.png"/><img class="lazyload blur flex-shrink-0 mb-0 mr-3 rounded-full w-14 h-14 select-none cursor-pointer hvr-float-shadow" alt="Profile" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAJCAYAAAALpr0TAAAAAklEQVR4AewaftIAAAFBSURBVAXBSS8DYQCA4fcz33RqWpUuU8tEkKjtUqIhJELiRCJxcfRf/AknP8OFiwMXF40DSVO0iRhLVbR0mX08jzg63Ikc28NzA1QR8vBcJ6Eq9AYUDMNAxlOsrBSRH40WIoLJbIL1qTzS63JvfRKJECd0MM0h9IREmZ4YOyaAw7UCG6UlNpfneaw8UbNa4Ie4tk9uSEO6nouCoO9FZEZNWu8WcUViZpLsH+wyMjnBX7eDzCuQ0zVsAtpvb1RrL9Stb3RNkO//MSwl6mAcWRrNMLO1jZ5UuSiXITXO6vISp+eXbNs+olal02kj/YUidiyJ5wsK63u8N74xSxmmyrecnF2TNtJoUkUa2RxO95ew3+al1yXm9tCCiLnCLPqrRbP5QSRC5GLsi0DVkekUj5UKjZ8+TSdA6ikWigYDqs/VzR3/TEV/Airrby8AAAAASUVORK5CYII="/></picture><p class="text-base leading-7 font-semibold">不正经的人机交互工程师</p></div></footer></article><nav class="flex flex-wrap justify-between mb-10"><a class="text-lg font-bold" href="/post/RESTful">← <!-- -->RESTful资源命名规范</a><a class="text-lg font-bold" href="/post/compose">redux源码系列之compose<!-- --> →</a></nav></main><footer class="text-lg font-light mt-3">© <!-- -->2021<!-- --> <!-- -->Built with<!-- --> <a href="https://nextjs.org/">Next.js</a>🔥, Deployed on<!-- --> <a href="https://pages.github.com/">GitHub Pages</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"redux源码系列之createStore","date":"June 23, 2021","description":"深入源码解析createStore内部代码"},"post":{"content":"\n``` javascript\nconst store = createStore(reducer, [initState, enhancer])\n```\n\n## 参数\n\n1. [**reducer**](https://redux.js.org/understanding/thinking-in-redux/glossary#reducer) (*Function*):  接受两个参数，分别是当前的 **state** 和要处理的 [**action**](https://redux.js.org/tutorials/fundamentals/part-2-concepts-data-flow#actions)\n\n2. [**preloadedState**] (*any*):  初始状态的 **state**，其实在实际开发中很少在这边给应用赋上初始 **state**，一般会在各自的 **reducer** 中赋上初始 **state**: \n\n``` javascript\nconst initialState = {}\n\n  // reducer\nconst todoApp = (state = initialState, action) =\u003e {\n  // 这里暂不处理任何 action，\n  // 仅返回传入的 state。\n  return state\n}\n```\n值得注意的是: 通常情况下，通过 **preloadedState** 指定的 **state** 要优先于通过 **reducer** 指定 **state** : \n\n``` javascript\nimport { createStore } from 'redux';\n// reducer\nconst a = (state = 'lol', action) =\u003e {\n  return state;\n}\n\nconst b = (state = 'wat', action) =\u003e {\n  return state;\n}\n\n// const combined = combineReducers({ a, b })\nconst combined = (state = {}, action) =\u003e {\n  return {\n    a: a(state.a, action),\n    b: b(state.b, action)\n  };\n}\n\nconst store = createStore(combined, { a: 'horse' });\nconsole.log(store.getState()); // { a: 'horse', b: 'wat' }\n```\n\n3. [**enhancer**] (*Function*):  高阶函数，通常是指中间件，必须用 **applyMiddleware()** 包装下：\n\n``` javascript\nimport { createStore, applyMiddleware } from 'redux';\nimport thunk from 'redux-thunk';\n\nfunction logger({ getState }) {\n  return next =\u003e action =\u003e {\n    console.log('will dispatch', action)\n\n    // Call the next dispatch method in the middleware chain.\n    const returnValue = next(action)\n\n    console.log('state after dispatch', getState())\n\n    // This will likely be the action itself, unless\n    // a middleware further in chain changed it.\n    return returnValue\n  }\n}\n\nconst store = createStore(todos, applyMiddleware(thunk, logger))\n```\n\n## 返回值\n[**store**](https://redux.js.org/api/store): 是一个对象，包含了一些方法（[**dispatch**](https://redux.js.org/api/store#dispatchaction)，[**getState**](https://redux.js.org/api/store#getstate)等)，保存了应用所有 **state** 的对象。改变 **state** 的惟一方法是 **dispatch action**。\n\n``` typescript\nconst store = {\n  dispatch: dispatch as Dispatch\u003cA\u003e,\n  subscribe,\n  getState,\n  replaceReducer,\n  [$$observable]: observable\n} as unknown as Store\u003cExtendState\u003cS, StateExt\u003e, A, StateExt, Ext\u003e \u0026 Ext\nreturn store\n```\n\n## 代码结构\n便于理解，我们忽略函数中 **TS** 的一些类型定义，大致结构如下：\n\n``` javascript\nfunction createStore(reducer, preloadedState, enhancer) {\n  // 传入参数的判断\n  // ...\n\n  // 参数中enhancer function存在，一般是指applyMiddleware()\n  if (typeof enhancer !== \"undefined\" \u0026\u0026 typeof enhancer === \"function\") {\n    return enhancer(createStore)(reducer, preloadedState);\n  }\n\n  let currentReducer = reducer; // 当前store中的reducer\n  let currentState = preloadedState; // 当前store中存储的状态\n  let currentListeners = []; // 当前store中放置的监听函数\n  let nextListeners = currentListeners; // 下一次dispatch时的监听函数\n  let isDispatching = false; // 用于判断是否正在dispatch\n\n  // 获取state\n  function getState() {\n    //...\n  }\n\n  // 添加一个监听函数，每当dispatch被调用的时候都会执行这个监听函数\n  function subscribe() {\n    //...\n  }\n\n  // 触发了一个action，因此我们调用reducer，得到的新的state，并且执行所有添加到store中的监听函数。\n  function dispatch() {\n    //...\n  }\n\n  // 忽略两个不常用的方法replaceReducer，observable...\n\n  // createStore的时候会执行一次INIT action的dispatch\n  // 便于其他reducer获取初始值\n  dispatch({ type: ActionTypes.INIT } as A);\n\n  return {\n    dispatch,\n    subscribe,\n    getState,\n    //下面两个是主要面向库开发者的方法，暂时先忽略\n    //replaceReducer,\n    //observable\n  };\n}\n```\n\n可以看出，**createStore** 方法创建了一个 **store**，但是并没有直接将这个 **store** 的状态 **state** 返回，而是返回了一系列方法，外部可以通过这些方法（**getState**）获取 **state**，或者间接地（通过调用 **dispatch** ）改变 **state**。\n\n下面我们来看下各个方法的具体实现\n\n### getState\n\n``` typescript\nfunction getState(): S {\n  // 如果正在dispath会抛出异常\n  if (isDispatching) {\n    throw new Error(\n      'You may not call store.getState() while the reducer is executing. ' +\n        'The reducer has already received the state as an argument. ' +\n        'Pass it down from the top reducer instead of reading it from the store.'\n    )\n  }\n\n  return currentState as S\n}\n```\n\n很简单，就是获取当前 **state**，我们可以通过 ``` store.getState() = ... ``` 来修改 **state**，但是一般来说，redux不建议这样做，只能通过 **dispatch action** 来修改 **state**。\n\n### subscribe\n\n``` typescript\n  // 若相等，做一下currentListeners浅拷贝\n  function ensureCanMutateNextListeners() {\n    if (nextListeners === currentListeners) {\n      nextListeners = currentListeners.slice()\n    }\n  }\n\n  function subscribe(listener: () =\u003e void) {\n    if (typeof listener !== 'function') {\n      // throw Error\n    }\n    if (isDispatching) {\n      // throw Error\n    }\n    //设置一个标志，标志该监听器已经订阅了\n    let isSubscribed = true\n\n    ensureCanMutateNextListeners()\n    // push到nextListeners数组中，下次dispatch会调用\n    nextListeners.push(listener)\n\n    // 返回了一个取消订阅的函数，即从数组中删除该监听函数\n    return function unsubscribe() {\n      // 如果已经取消订阅过了，直接返回\n      if (!isSubscribed) {\n        return\n      }\n      if (isDispatching) {\n        // throw Error\n      }\n\n      isSubscribed = false\n\n      ensureCanMutateNextListeners()\n      // 从下一轮的监听函数数组（用于下一次dispatch）中删除这个监听器。\n      const index = nextListeners.indexOf(listener)\n      nextListeners.splice(index, 1)\n      // 清空当前currentListeners\n      currentListeners = null\n    }\n  }\n```\n\n### dispatch\n\n``` typescript\nfunction dispatch(action: A) {\n  if (!isPlainObject(action)) {\n    // throw Error\n  }\n\n  if (typeof action.type === 'undefined') {\n    // throw Error\n  }\n\n  if (isDispatching) {\n    // throw Error\n  }\n\n  try {\n    // 标记正在dispatch\n    isDispatching = true\n    // 调用reducer，得到新state\n    currentState = currentReducer(currentState, action)\n  } finally {\n    isDispatching = false\n  }\n\n  const listeners = (currentListeners = nextListeners)\n  // 遍历执行监听数组中的所有监听函数\n  for (let i = 0; i \u003c listeners.length; i++) {\n    const listener = listeners[i]\n    listener()\n  }\n\n  // 返回传入的action\n  return action\n}\n```\n\n**dispatch** 是修改 **state** 的唯一途径（**redux** 规定）。\n\n## 总结\n整个 **createStore** function 还是比较容易理解的，记住应用中应有且仅有一个 store。\n\n## 参考\n- [Redux createStore API](https://redux.js.org/api/createstore)\n- [Redux createStore API（中文版）](https://www.redux.org.cn/docs/api/createStore.html)\n","excerpt":""},"previousPost":{"slug":"RESTful","frontmatter":{"title":"RESTful资源命名规范","date":"June 8, 2021","description":"资源路径如何正确的定义？应该遵守怎样的命名规范？"},"excerpt":"","content":"\n在 **REST** 中，主要的数据描述称为 **Resource**，拥有明确一致的 **REST** 命名规范，长期来看将是最好的决策\n\n\u003e 资源可以是单例或者集合，比如说，customers是一个集合资源，customer是一个单个资源。我们在URI中可以用\"/customers\"来定义集合资源，用\"/customers/{customerId}\"来定义单个资源。\n\n\u003e 一个资源也可以包含子集合资源，比如说，一个顾客他名下有多个account，我们可以这样\"/customers/{customerId}/accounts\"表示。相同的，单独表示某个顾客的某个账号，我们可以这样\"/customers/{customerId}/accounts/{accountId}\"。\n\n## Tips\n1. 使用名词表示资源（而不是动词）\n\n\n2. 使用\"/\"表示层次关系\n\n```url\nhttp://api.example.com/customers/{customerId}/accounts/{accountId}\n```\n\n\n3. 结尾不需要加\"/\"\n\n```url\nhttp://api.example.com/device-management/managed-devices/\n\n//better\nhttp://api.example.com/device-management/managed-devices\n```\n\n4. 用\"-\"代替驼峰的命名方式，提高可读性,\n   也不要使用下划线\"_\"（某些字体下会显示不明显，或者被遮盖）\n\n```url\nhttp://api.example.com/inventoryManagement/managedEntities/{id}/installScriptLocation \n\nhttp://api.example.com/inventory_management/managed_entities/{id}/install_script_location\n\n//better\nhttp://api.example.com/inventory-management/managed-entities/{id}/install-script-location\n```\n\n5. 使用小写字母\n\n\n6. 不要加文件后缀\n\n```url\nhttp://api.example.com/device-management/managed-devices.xml  /*Do not use it*/\n\nhttp://api.example.com/device-management/managed-devices \t/*This is correct URI*/\n```\n\n7. 不要使用CRUD的一些方法名词（例如：getXXX，deletXXX，与第一点类似）\n\n```url\nHTTP GET http://api.example.com/device-management/managed-devices  //Get all devices\nHTTP POST http://api.example.com/device-management/managed-devices  //Create new Device\n\nHTTP GET http://api.example.com/device-management/managed-devices/{id}  //Get device for given Id\nHTTP PUT http://api.example.com/device-management/managed-devices/{id}  //Update device for given Id\nHTTP DELETE http://api.example.com/device-management/managed-devices/{id}  //Delete device for given Id\n```\n\n\n8. 用query形式来过滤资源集合（区别于params形式，理解）\n```url\nhttp://api.example.com/device-management/managed-devices\n\nhttp://api.example.com/device-management/managed-devices?region=USA\nhttp://api.example.com/device-management/managed-devices?region=USA\u0026brand=XYZ\nhttp://api.example.com/device-management/managed-devices?region=USA\u0026brand=XYZ\u0026sort=installation-date\n```\n\n\n## 参考：\n- [resource-naming](https://restfulapi.net/resource-naming)\n"},"nextPost":{"slug":"compose","frontmatter":{"title":"redux源码系列之compose","date":"June 23, 2021","description":null},"excerpt":"","content":"\n本来想写 **applyMiddleware** 方法代码解析的，然后一看，里面有个 **compose** 方法，好像内部代码也调用的比较多，想了想就决定先看下 **compose** 相关代码。\n\n``` javascript\nimport { compose } from 'redux'\n\nconst composeFn = compose(fn1, fn2, fn3, fn4)\nconst b = composeFn(x)\n// 等价于\nconst b = fn1(fn2(fn3(fn4(x))))\n```\n从使用上大概可以看出它的作用，从右往左的组合执行多个函数，将多个函数组合成一个函数，右边函数的执行结果是左边函数的参数值，\n除了最右边的函数可以传入多个参数，其余函数只能传入一个参数。\n\n## 参数\n1. **(arguments)**: 需要组合的函数。\n\n## 返回值\n**(Function)**: 从右到左把接收到的函数合成后的最终函数。\n\n## 代码结构\n代码算是很简单了，我们分两部分去理解\n\n### 上半部分\n\n``` typescript\nexport default function compose(): \u003cR\u003e(a: R) =\u003e R\n\nexport default function compose\u003cF extends Function\u003e(f: F): F\n\n/* two functions */\nexport default function compose\u003cA, T extends any[], R\u003e(\n  f1: (a: A) =\u003e R,\n  f2: Func\u003cT, A\u003e\n): Func\u003cT, R\u003e\n\n/* three functions */\nexport default function compose\u003cA, B, T extends any[], R\u003e(\n  f1: (b: B) =\u003e R,\n  f2: (a: A) =\u003e B,\n  f3: Func\u003cT, A\u003e\n): Func\u003cT, R\u003e\n\n/* four functions */\nexport default function compose\u003cA, B, C, T extends any[], R\u003e(\n  f1: (c: C) =\u003e R,\n  f2: (b: B) =\u003e C,\n  f3: (a: A) =\u003e B,\n  f4: Func\u003cT, A\u003e\n): Func\u003cT, R\u003e\n\n/* rest */\nexport default function compose\u003cR\u003e(\n  f1: (a: any) =\u003e R,\n  ...funcs: Function[]\n): (...args: any[]) =\u003e R\n\nexport default function compose\u003cR\u003e(...funcs: Function[]): (...args: any[]) =\u003e R\n\nexport default function compose(...funcs: Function[]) {\n  \n}\n```\n\n声明各种不同参数的 **compose**，其实是重载，为了写代码时有更好的代码提示。\n\n### 核心部分\n``` typescript\nreturn funcs.reduce(\n  (a, b) =\u003e\n    (...args: any) =\u003e\n      a(b(...args))\n)\n```\n最后 **compose return** 的是函数数组（即传入的参数）的 **reduce** 方法，显而易见的能组合成高阶函数的形式。\n\n## 总结\n\n``` javascript\ncompose(fn1, fn2, fn3, fn4)(...args) === fn1(fn2(fn3(fn4(...args))))\n```\n\n**compose** 函数在函数式编程里很常见。这里 **redux** 的对 **compose** 实现很简单，主要还是要对 **Array.prototype.reduce** 函数要熟练。\n\n"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"createStore"},"buildId":"suk5khTdIywjlW7o5cfBo","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-c6f966696d7d46f48c33.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.10b3d8f36ae5d485c3da.js" async=""></script><script src="/_next/static/chunks/commons.18cd929bdef6e2f96561.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c6d80ab417193f95407.js" async=""></script><script src="/_next/static/chunks/1173eff4538ab0eae4f3f506dea9a7965770ad37.c3b64f225a2ce340a522.js" async=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-e6569f7c0ca247bf517f.js" async=""></script><script src="/_next/static/suk5khTdIywjlW7o5cfBo/_buildManifest.js" async=""></script><script src="/_next/static/suk5khTdIywjlW7o5cfBo/_ssgManifest.js" async=""></script></body></html>